<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Tracker Profile</title>
    <link rel="stylesheet" type="text/css" href="../public/style.css">
    <script src="https://kit.fontawesome.com/02fd43601a.js" crossorigin="anonymous"></script>
</head>
<body>
    <h1>Welcome to the Bug Tracker</h1>
    <nav>
      <ul>
        <li><a href="#submit-a-bug">Submit a Bug</a></li>
        <li><a href="#view-bugs">View Bugs</a></li>
      </ul>
    </nav>
    <h2 id="submit-a-bug">Submit a Bug</h2>
    <form id="newBug" action="/profile/api" method="post">
      <label for="title">Title*:</label>
      <input type="text" id="title" name="title"><br>
      <label for="description">Description*:</label>
      <textarea id="description" name="description"></textarea><br>
      <label for="assigned_to">Assigned to:</label>
      <input type="text" id="assigned_to" name="assigned_to"><br>
      <label for="priority">Priority:</label>
      <select name="priority" id="priority">
        <option value="" disabled selected>Bug priority</option>
        <option value="urgent">Urgent</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
      <br>
      <input type="submit" value="Submit">
    </form>
    <code id="jsonResult"></code>
    <div id="view-bugs">      
    <h2>View Bugs</h2>
    <div id="find-sort">
      <input type="text" id="search" placeholder="Search for bugs..." title="">
      <i class="fa-solid fa-magnifying-glass"></i>
      <div id="sort">
        <a class="sort-btn" href="javascript:void(0)">Sort by
          <i class="fa-solid fa-chevron-down sort-btn"></i></a>
          <div id="myDropdown" class="dropdown-content">
            <a class="sort-option" name="priority" href="javascript:void(0)">Priority</a>
            <a class="sort-option" name="recent" href="javascript:void(0)">Recent</a>
            <a class="sort-option" name="oldest" href="javascript:void(0)">Oldest</a>
            <a class="sort-option" name="update" href="javascript:void(0)">Update</a>
          </div>
      </div>
    </div>
    <div id='bugList'></div>
  </div>
    <a href="/account/logout">Logout</a>

    <script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
    <script>
      let url = '/profile/api'
      function formatTime(str) {
	      let month = {
    	    Jan: '01',
      	  Feb: '02',
      	  Mar: '03',
      	  Apr: '04',
      	  May: '05',
      	  Jun: '06',
      	  Jul: '07',
      	  Aug: '08',
      	  Sep: '09',
      	  Oct: '10',
      	  Nov: '11',
      	  Dec: '12'
        };
  
        let strMonth = month[str.slice(4, 7)];
        const newStr = `${str.slice(8,10)}/${strMonth}/${str.slice(11,15)} ${str.slice(15,21)}`;
  
        return newStr
      }
      // Stringfy json response after data submission
      $(function() {
        $('#newBug').submit(function(e) {
          $.ajax({
            url: '/profile/api',
            type: 'post',
            data: $('#newBug').serialize(),
            success: function(data) {
              $('#jsonResult').text(JSON.stringify(data));
            }
          });
          e.preventDefault();
        })
      })

      // Sorting bugs
      $('.sort-option').on('click', function(e) {
        url = url + '?sort=' + $(this).attr('name');
        $.ajax({
          type: "GET",
          url: url,
          success: function(data) {
            url = '/profile/api';
            let issues = [];
            data.forEach(function(element) {
              (element.open) ? openStatus = 'open' : openStatus = 'closed';
              let priority = element.priority.charAt(0).toUpperCase() + element.priority.slice(1);
              let single = [
                '<div class="bug-issue '+openStatus+'">',
                  '<h3>'+element.bug_title+' - ('+openStatus+')</h3>',
                  '<br>',
                  '<p>'+element.bug_description+'</p>',
                  '<p class="priority-'+element.priority+'"><b>Priority:</b> '+priority+'</p>',
                  '<p><b>Created by:</b> '+element.created_by+'       <b>Assigned to:</b> '+element.assigned_to+'</p>',
                  '<p><b>Created on:</b> '+formatTime(element.created_on)+'       <b>Last updated:</b> '+formatTime(element.updated_on)+'</p><br>',
                  '<a href="#" class="closeIssue" id="'+element._id+'">Close?</a> <a href="#" class="deleteIssue" id="'+element._id+'">Delete?</a>',
                  '</div>'
              ];
              issues.push(single.join(''));
            });
            $('#bugList').html(issues.join(''));
            return url;
          }
        })
      })

      // GET all the submitted bugs
      $(function() {
        $.ajax({
          type: "GET",
          url: url,
          success: function(data) {
            let issues = [];
            data.forEach(function(element) {
              (element.open) ? openStatus = 'open' : openStatus = 'closed';
              let priority = element.priority.charAt(0).toUpperCase() + element.priority.slice(1);
              let single = [
                '<div class="bug-issue '+openStatus+'">',
                  '<h3>'+element.bug_title+' - ('+openStatus+')</h3>',
                  '<br>',
                  '<p>'+element.bug_description+'</p>',
                  '<p class="priority-'+element.priority+'"><b>Priority:</b> '+priority+'</p>',
                  '<p><b>Created by:</b> '+element.created_by+'       <b>Assigned to:</b> '+element.assigned_to+'</p>',
                  '<p><b>Created on:</b> '+formatTime(element.created_on)+'       <b>Last updated:</b> '+formatTime(element.updated_on)+'</p><br>',
                  '<a href="#" class="closeIssue" id="'+element._id+'">Close?</a> <a href="#" class="deleteIssue" id="'+element._id+'">Delete?</a>',
                  '</div>'
              ];
              issues.push(single.join(''));
            });
            $('#bugList').html(issues.join(''));
          }
        })
      })
      $('#bugList').on('click', '.deleteIssue', function(e) {
        let url = "/profile/api/" + $(this).attr('id');
        $.ajax({
          type: "DELETE",
          url: url,
          success: function(data) {window.location.reload(true);}
        });
        e.preventDefault(); 
      })
      $('#bugList').on('click', '.closeIssue', function(e) {
        let url = "/profile/api/" + $(this).attr('id');
        $.ajax({
          type: "PUT",
          url: url,
          success: function(data) {window.location.reload(true);}
        });
        e.preventDefault();
      })

      // Show and hide sort dropdown
      $(window).on('click', function(event) {
        const e = event.target;
        if ((!$('#myDropdown').hasClass('show') && $(e).hasClass('sort-btn')) || ($('#myDropdown').hasClass('show') && !$(e).hasClass('sort-option'))) {
          $('#myDropdown').toggleClass('show');
        }
      })
    </script>
</body>
</html>