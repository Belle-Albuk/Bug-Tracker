<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Tracker Profile</title>
    <link rel="stylesheet" type="text/css" href="../public/style.css">
    <script src="https://kit.fontawesome.com/02fd43601a.js" crossorigin="anonymous"></script>
</head>
<body>
    <h1>Welcome to the Bug Tracker</h1>
    <nav>
      <ul>
        <li><a href="#submit-a-bug">Submit a Bug</a></li>
        <li><a href="#view-bugs">View Bugs</a></li>
      </ul>
    </nav>
    <h2 id="submit-a-bug">Submit a Bug</h2>
    <form id="newBug" action="/profile/api" method="post">
      <label for="title">Title*:</label>
      <input type="text" id="title" name="title"><br>
      <label for="description">Description*:</label>
      <textarea id="description" name="description"></textarea><br>
      <label for="assigned_to">Assigned to:</label>
      <input type="text" id="assigned_to" name="assigned_to"><br>
      <label for="priority">Priority:</label>
      <select name="priority" id="priority">
        <option value="" disabled selected>Bug priority</option>
        <option value="urgent">Urgent</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
      <br>
      <input type="submit" value="Submit">
    </form>
    <div id="view-bugs">      
    <h2>View Bugs</h2>
    <div id="find-sort">
      <input type="text" name="search" id="search" placeholder="Search for bugs..." title="">
      <i class="fa-solid fa-magnifying-glass"></i>
      <div id="sort">
        <a class="sort-btn" href="javascript:void(0)">Sort by
          <i class="fa-solid fa-chevron-down sort-btn"></i></a>
          <div id="dropdown" class="dropdown-content">
            <a class="sort-option" name="priority" href="javascript:void(0)">Priority</a>
            <a class="sort-option" name="recent" href="javascript:void(0)">Recent</a>
            <a class="sort-option" name="oldest" href="javascript:void(0)">Oldest</a>
            <a class="sort-option" name="update" href="javascript:void(0)">Update</a>
          </div>
      </div>
    </div>
    <div id='bugList'></div>
  </div>
    <a href="/account/logout">Logout</a>

    <script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
    <script>
      let url = '/profile/api'
      function formatTime(str) {
	      let month = {
    	    Jan: '01',
      	  Feb: '02',
      	  Mar: '03',
      	  Apr: '04',
      	  May: '05',
      	  Jun: '06',
      	  Jul: '07',
      	  Aug: '08',
      	  Sep: '09',
      	  Oct: '10',
      	  Nov: '11',
      	  Dec: '12'
        };
  
        let strMonth = month[str.slice(4, 7)];
        const newStr = `${strMonth}/${str.slice(8,10)}/${str.slice(11,15)} ${str.slice(15,21)}`;
  
        return newStr
      }

      function dataToHtml(data) {
        let issues = [];
        data.forEach(function(element) {
          (element.open) ? openStatus = 'open' : openStatus = 'closed';
          (element.priority) ? priority = element.priority.charAt(0).toUpperCase() + element.priority.slice(1) : priority = '';
          let single = [
            '<div class="bug-issue '+openStatus+'"><div class="parent">',
            '<h3>'+element.bug_title+' - ('+openStatus+')</h3>',
            '<br>',
            '<p class="description">'+element.bug_description+'</p>',
            '<p class="'+element.priority+' priority"><b>Priority:</b> '+priority+'</p>',
            '<p class="created_by" id="'+element.created_by+'"><b>Created by:</b> '+element.created_by+'       <b>Assigned to:</b> '+element.assigned_to+'</p>',
            '<p class="created_on" id="'+formatTime(element.created_on)+'"><b>Created on:</b> '+formatTime(element.created_on)+'       <b>Last updated:</b> '+formatTime(element.updated_on)+'</p><br>',
            '<a href="#" class="closeIssue" id="'+element._id+'">Close?</a> <a href="#" class="deleteIssue" id="'+element._id+'">Delete?</a>',
            '</div></div>'
          ];          
          issues.push(single.join(''));
        });
        $('#bugList').html(issues.join(''));
      }

      // Post new bug issue
      $(function() {
        $('#newBug').submit(function(e) {
          $.ajax({
            url: '/profile/api',
            type: 'post',
            data: $('#newBug').serialize(),
            success: function(data) {window.location.reload(true);}
          });
          e.preventDefault();
        })
      })

      // Search bugs
      $('#search').keypress(function(e) {        
        if (e.which === 13) {
          url = url + '?search=' + $(this).val();
          $.ajax({
            type: 'GET',
            url: url,
            success: function(data) {
              url = '/profile/api';
              dataToHtml(data);
              return url;
            }
          })
        }
      })

      // Sorting bugs
      $('.sort-option').on('click', function(e) {
        url = url + '?sort=' + $(this).attr('name');
        $.ajax({
          type: "GET",
          url: url,
          success: function(data) {
            url = '/profile/api';
            dataToHtml(data);
            return url;
          }
        })
      })

      // GET all the submitted bugs
      $(function() {
        $.ajax({
          type: "GET",
          url: url,
          success: function(data) {
            dataToHtml(data);
          }
        })
      })
      $('#bugList').on('click', '.deleteIssue', function(e) {
        let url = "/profile/api/" + $(this).attr('id');
        $.ajax({
          type: "DELETE",
          url: url,
          success: function(data) {window.location.reload(true);}
        });
        e.preventDefault(); 
      })
      $('#bugList').on('click', '.closeIssue', function(e) {
        let url = "/profile/api/" + $(this).attr('id');
        $.ajax({
          type: "PUT",
          url: url,
          success: function(data) {window.location.reload(true);}
        });
        e.preventDefault();
      })

      // Show and hide sort dropdown
      $(window).on('click', function(event) {
        const e = event.target;
        if ((!$('#dropdown').hasClass('show') && $(e).hasClass('sort-btn')) || ($('#dropdown').hasClass('show') && !$(e).hasClass('sort-option'))) {
          $('#dropdown').toggleClass('show');
        }
      })

      // Edit bug issues
      $(document).on('dblclick', '.bug-issue', function() {
        function findSelectedPriority(elementPriority) {
            let arr = ['<option value="">Bug priority</option>',
            '<option value="urgent">Urgent</option>',
            '<option value="medium">Medium</option>',
            '<option value="low">Low</option>'
            ]
            let newArr = [];
            if (elementPriority) {
              for (let i = 0; i < arr.length; i++) {
            	  if (arr[i].includes(elementPriority)) {
                	newArr.push(arr[i].slice(0, 7) + ' selected' + arr[i].slice(7));
                } else {newArr.push(arr[i])}
              }
			        return newArr.join("");
            } else {return arr.join("")}
          }

          const title = $(this).children('h3').text().match(/^.+?(?= -)/g).join("");
          
          let edit = [
            '<div id="child"><form><div id="edit-nav"><h1>Edit Bug Issue</h1></div>',
            '<label for="title"><b>Title:</b></label><input type="text" class="title" name="title" value="'+title+'"><br><br><br>',
            '<label for="description"><b>Description:</b></label><br><textarea class="description" name="description">'+$(this).children('.description').text()+'</textarea><br>',
            '<label for="priority"><b>Priority:</b></label><select name="priority" id="priority">'+findSelectedPriority($(this).children('.priority').attr('class').split(' ')[0])+'</select>',
            '<div id="block"><div class="left"><p><b>Created by:</b>'+$(this).children('.created_by').attr('id')+'</p>',
            '<p><b>Created on:</b> '+$(this).children('.created_on').attr('id')+'</p></div>',
            '<div class="right"><label for="assigned_to"><b>Assigned to:</b></label><input type="text" name="assigned_to" value="'+$(this).children('.created_by').text().match(/(?<=Assigned to: ).+$/g).join("")+'">',
            '<p><b>Last updated:</b> '+$(this).children('.created_on').text().match(/(?<=Last updated: ).+$/g).join("")+'</p></div>',
            '</div><br>',
            '<button id="cancel" name="cancel">Cancel</button>',
            '<button id="save" name="save">Save</button></form></div>'
          ]
          $(this).append(edit.join(""));
      })
    </script>
</body>
</html>